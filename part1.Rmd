---
title: "Project_Pt1"
output: pdf_document
date: "2023-02-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(ggthemes)
library(statar) 
library(tidyquant)
library(purrr)
library(sandwich)
library(lmtest)
atlas <- read_dta("atlas.dta")
view(atlas)


```

***Question 1***
My name is Jose and I am from Willow Spring, North Carolina. My community is on the southern edge of Wake County. The map below shows adult household income for children born to low income parents. Compared to similar children nationwide, my neighborhood has below average outcomes. 

![](map.png)

```{r q2}

#Question 2: Summary statistics of all variables, including recording all missing values. 
summary(atlas)

```

Most variables have at least some number of missing values. Many of them lack values for almost all tracts, especially the variables that pool data at the household level for different racial groups. This may be because many racial tracts do not have enough people belonging to that racial group to collect enough aggregate data for that given variable.

***Question 3***
The `kfr_pooled_pooled_p25` variable calculates the mean percentile rank for household income for people born to parents at the 25th percentile of the national distribution of household income. In other words, the higher the value for this variable, the higher absolute mobility. This is calculated with using a linear model to capture the effect that being born to parents at the 25th percentile of household income will have on income outcomes as adults, pooled at the census tract level.  

```{r q4}

#Question 4: Histogram of Absolute Mobility at the 25th percentile 

absmob_histo <- atlas |> 
                ggplot() + 
                geom_histogram(aes(x = kfr_pooled_pooled_p25, y = after_stat(density))) + 
                labs(title = "Ranked Absolute Mobility at the 25th Percentile",
                     subtitle = "For household income 2014-15",
                     x = "Mean percentile rank ")
absmob_histo 

ggsave("absmob_histo.png")


```
The histogram shows an approximately normal distribution of mean percentile rank of absolute mobility at the 25th percentile, slightly left skewed. The majority of pooled census tract absolute mobility ranks are between 25 and 50. 

```{r q5}

#Question 5: Summary statistics for kfr_pooled_pooled_p25

sumstats <- summary(atlas$kfr_pooled_pooled_p25, na.rm = TRUE)
sdstats <- sd(atlas$kfr_pooled_pooled_p25, na.rm = TRUE)
#creating a table of those values 
sumstat <- data.frame(c("Min", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max", "SD", "NAs"),
                       c(-3.286, 38.070, 42.520, 42.858, 47.350, 103.349, 7.126422, 1189))
names(sumstat)[1] <- "Summary Stats"
names(sumstat)[2] <- "Values"
sumstat <- sumstat |> 
          mutate(Values = round(Values, 2))
sumstat
```

***Question 6***
`kfr_pooled_pooled_p25` can be negative or above 100 in these data because of the limitations of a simple linear model. The model does not know that we are trying to create a standardized percentile rank variable that (logically) starts at 0 and ends at 100. It simply receives a variable (in this case, parents' percentile rank of national household income pooled at the census tract) and uses it to predict the values of a dependent variable (kid percentile rank of household income). Because we are working with a large dataset, it is natural that the model, even when using standardized percentile values, will report values that are below 0 and above 100. 

```{r q7}

#Question 7: comparing absolute mobiltiy at the 25th percentile in my census tract, state, and across the U.S.

usabsmob <- mean(atlas$kfr_pooled_pooled_p25, na.rm = TRUE) #mean of absolute mobility nationwide
ncabsmob <- mean(atlas$kfr_pooled_pooled_p25[atlas$state == "37"], na.rm = TRUE) #mean of absolute mobility in NC
myhood <- atlas %>% subset(state == "37" & county == "183" & tract == "53110") #creating data frame of just my tract
myhoodabsmob<- mean(myhood$kfr_pooled_pooled_p25, na.rm = TRUE) #mean of absolute mobility in my neighborhood

abscomp <- data.frame(c("My Neighborhood", "North Carolina", "United States"),
                       c(myhoodabsmob, ncabsmob, usabsmob))
names(abscomp)[1] <- "Level"
names(abscomp)[2] <- "Absolute Mobility at the 25th Percentile"
abscomp


```

My neighborhood/census tract has a slightly higher level of absolute mobility (at the 25th percentile) compared to my home state of North Carolina. Both my census tract and North Carolina have a lower level of absolute mobility than the national average.

```{r q8}

#Question 8: calculating and comparing standard deviations of absolute mobility in my home county, state, and nationwide

usasd <- sd(atlas$kfr_pooled_pooled_p25, na.rm = TRUE) #sd of absolute mobility nationwide
ncsd <- sd(atlas$kfr_pooled_pooled_p25[atlas$state == "37"], na.rm = TRUE) #sd of absolute mobility in NC
wake_co <- atlas %>% subset(state == "37" & county == "183") #creating data frame of just my tract
countysd<- sd(wake_co$kfr_pooled_pooled_p25, na.rm = TRUE) #sd of absolute mobility in my county

sdcomp <- data.frame(c("Wake County", "North Carolina", "United States"),
                       c(countysd, ncsd, usasd))
names(sdcomp)[1] <- "Level"
names(sdcomp)[2] <- "Std Dev of Absolute Mobility at the 25th Percentile"
sdcomp
```

The standard deviation of mobility outcomes for my Wake County, NC (7.69) is slightly higher than the standard deviation at the national level. North Carolina's mobility outcome standard deviation of 5.75 is lower than the amount of spread at the county or national level. This gives us a sense of how results may vary, which makes sense because of the increasing sample size for each successive level of analysis.

```{r q9}

#Question 9: plotting the relationship between upward mobility and rent in my neighborhood

#9a: Scatter plot of my home county

scatterrent <- atlas |> 
           filter(state == 37,
                  county == 183) |> 
           ggplot() +
           geom_point(aes(x = rent_twobed2015, y = kfr_pooled_pooled_p25)) +
           geom_smooth(aes(x = rent_twobed2015, y = kfr_pooled_pooled_p25), method = "lm", se = F) +
           labs(x = "Average Rent for Two-Bedroom Apt",
                y = "Absolute Mobility at the 25th Percentile",
                title = "Relationship between rent and absolute mobility in Wake County, NC") +
          scale_x_continuous(labels = scales::dollar_format()) 
scatterrent

ggsave("scatterrent.png")


```

***Question 9B***
There is an apparent positive correlation between rent and absolute mobility at the 25th percentile. The line of best fit suggests that as rent increases in my home county, the percentile rank of absolute mobility increases as well. This suggests that low income children living in higher-priced tracts experience higher mobility than low income children living in cheaper (and, presumably, more economicallly and socially disadvantaged) tracts. 

***Question 9C***
Opportunity bargains are neighborhoods with cheaper than average rents and above average absolute mobility outcomes. For this question, I am defining a given neighborhood an opportunity bargain if it has under $1500 in median two-bedroom rent and the highest percentile rank for absolute mobility at the 25th percentile for my given county. 

```{r q9c1}

#Question 9c: Defining Opportunity Bargains
myhood <- atlas %>% subset(state == "37" & county == "183" & tract == "53110") #creating data frame of just my tract
myhoodabsmob
myhoodrent <- mean(myhood$rent_twobed2015, na.rm = TRUE) #myneighborhood rent 
myhoodrent

```

With an absolute mobility rank (at the 25th percentile) of 38 and a median two-bedroom apartment rent of $710, my neighborhood can perhaps be considered an opportunity tract, but we would need to compare it to other tracts in my county to make a more practical judgment. What about other census tracts in my home county of Wake County?

```{r 9c2}

#Finding other opportunity bargains in my home county
wake_co <- atlas %>% subset(state == "37" & county == "183") #creating data frame of just my tract
wake_co$bargain_index <- wake_co$kfr_pooled_pooled_p25/wake_co$rent_twobed2015
wake_bargains <- wake_co |> 
                 select(tract_name, tract, kfr_pooled_pooled_p25, rent_twobed2015, bargain_index) |> 
                 arrange(desc(bargain_index))
print(wake_bargains)

```

Using the opportunity bargain index method derived by dividing the absolute mobility rank by the median two-bedroom rent, we see that my census tract is #21 out of the 186 tracts in my home county. Furthermore, we see that my tract's bargain index variable is influenced by the very cheap median rent in my neighborhood - but cheap rent alone does not make an opportunity bargain. Therefore, I would not classify my neighborhood/census tract as an opportunity bargain. I will go ahead and determine opportunity bargains those census tracts with rents under $1500 and an absolute mobility rank of over 50. Let's see where they are, if any.

```{r q9c3}

#Finding opportunity bargains in Wake County
top_bargains <- wake_bargains |> 
                filter(rent_twobed2015 <= 1500,
                       kfr_pooled_pooled_p25 >= 50)
print(top_bargains)

```
So now we see a list of 17 census tracts - from my experience, most of them clustered in the neighborhoods of upper middle-class North Raleigh and rapidly growing Cary - that we can reasonably say are opportunity bargains. Let's highlight them on the scatterplot of rent and absolute mobility to place them in the context of other census tracts. Do they stand out?

```{r 9c4}

#Highlighting opportunity bargains in Wake County, NC

scatterbargain <- atlas |> 
           filter(state == 37,
                  county == 183) |> 
           ggplot() +
           geom_point(aes(x = rent_twobed2015, y = kfr_pooled_pooled_p25)) +
           geom_point(data = top_bargains, aes(x = rent_twobed2015, y = kfr_pooled_pooled_p25),
                      color ="red", size = 3) +
           geom_text(aes(x = rent_twobed2015, y = kfr_pooled_pooled_p25, label = tract), check_overlap = TRUE,
                     size = 3, nudge_x = 2, nudge_y = 1) +
           geom_smooth(aes(x = rent_twobed2015, y = kfr_pooled_pooled_p25), method = "lm", se = F) +
           labs(x = "Average Rent for Two-Bedroom Apt",
                y = "Absolute Mobility at the 25th Percentile",
                title = "Relationship between rent and absolute mobility in Wake County, NC",
                subtitle = "Opportunity bargains highlighted in red") +
          scale_x_continuous(labels = scales::dollar_format()) 
scatterbargain

ggsave("scatterbargain.png")

```

And there they are! These are the bargain tracts with cheap rent and above average mobility outcomes in Wake County, NC.

```{r q10a1}

#Question 10: Tracking changes in Wake County over the last 20 years

#10A: scatter plot of poverty rate in 1990 and 2010 for Wake County 

wakepoverty <- atlas |> 
           filter(state == 37,
                  county == 183) |> 
           ggplot(aes(x = poor_share1990, y = poor_share2010)) +
           geom_point(aes(x = poor_share1990, y = poor_share2010)) +
           geom_smooth(method = "lm", se = F) +
           labs(x = "Poverty Rate in 1990",
                y = "Poverty rate in 2010",
                title = "Poverty Rate, 1990-2010 in Wake County, NC",
                subtitle = "Most tracts saw few changes in their poverty rate over time") 
wakepoverty

ggsave("wakepoverty.png")

```


```{r q10a2}

#10A: scatter plot of Black population in 1990 and 2010 for Wake County

wakeblack <- atlas |> 
           filter(state == 37,
                  county == 183) |> 
           ggplot(aes(x = share_black2000, y = share_black2010)) +
           geom_point() +
           geom_smooth(method = "lm", se = F) +
           labs(x = "Black population in 2000",
                y = "Black population in 2010",
                title = "Black population share 2000-2010 in Wake County, NC",
                subtitle = "Roughly equal number of census tracts saw their Black population share rise or fall over time") 
wakeblack

ggsave("wakeblack.png")

```


```{r q10a3}

#10A: scatter plot of Hispanic population in 1990 and 2010 for Wake County 

wakehisp <- atlas |> 
           filter(state == 37,
                  county == 183) |> 
           ggplot(aes(x = share_hisp2000, y = share_hisp2010)) +
           geom_point() +
           geom_smooth(method = "lm", se = F) +
           labs(x = "Hispanic population in 2000",
                y = "Hispanic population in 2010",
                title = "Hispanic population share 2000-2010 in Wake County, NC",
                subtitle = "Several tracts saw their Hispanic population grow significantly over time") 
wakehisp

ggsave("wakehisp.png")
```


```{r q10a4}

#10A: scatter plot of Asian population in 1990 and 2010 for Wake County 

wakeasian <- atlas |> 
           filter(state == 37,
                  county == 183) |> 
           ggplot(aes(x = share_asian2000, y = share_asian2010)) +
           geom_point() +
           geom_smooth(method = "lm", se = F) +
           labs(x = "Asian population in 2000",
                y = "Asian population in 2010",
                title = "Asian population share 2000-2010 in Wake County, NC",
                subtitle = "Select number of tracts saw their Asian population more than double over time") 
wakeasian

ggsave("wakeasian.png")
```


```{r q10a5}

#10A: scatter plot of White population in 1990 and 2010 for Wake County 

wakewhite <- atlas |> 
           filter(state == 37,
                  county == 183) |> 
           ggplot(aes(x = share_white2000, y = share_white2010)) +
           geom_point() +
           geom_smooth(method = "lm", se = F) +
           labs(x = "White population in 2000",
                y = "White population in 2010",
                title = "White population share 2000-2010 in Wake County, NC",
                subtitle = "Several tracts are no longer majority white") 
wakewhite

ggsave("wakewhite.png")

```
***Question 10B***
Between 1990, 2000, and 2010, Wake County saw relatively minor changes to its poverty rate, but significant changes to its demographic composition. Most tracts saw fairly little change in their poverty rate between 1990 and 2010. However, several tracts saw significant increases in their share of Asian and Hispanic populations between 2000 and 2010. At the same time, many tracts saw their share of the White population fall under 50%. This highlights the growing share of nonwhite populations in Wake County over the last few decades.

```{r q11}

#Question 11a: Average absolute mobility rate for neighborhoods grouped by HOLC grade (A, B, C, and D)

holcmobil <- atlas |> 
             mutate(grade = case_when(HOLC_A > 0.5 & !is.na(HOLC_A) ~ 'A',
                                      HOLC_B > 0.5 & !is.na(HOLC_B) ~ 'B',
                                      HOLC_C > 0.5 & !is.na(HOLC_C) ~ 'C',
                                      HOLC_D > 0.5 & !is.na(HOLC_D) ~ 'D')) |> 
            group_by(grade) |> 
            summarize(mean_absolute_mobility = mean(kfr_pooled_pooled_p25, na.rm = TRUE))
                      
holcmobil
                     

```
There is a clear pattern of increasing upward mobility for children born in the 1980s in Census tracts with higher 1930s HOLC grades. For tracts where a majority of its area was graded A, the average mobility rank at the 25th percentile is roughly 44. As we start to look at tracts with majority of their areas graded B through D, we see a consistent pattern of a decrease of 2-3 mobility percentile ranks. This suggests that practices such as redlining may have had an adverse effect on mobility outcomes in various neighborhoods that persists to this day. 

```{r q11b}

#Q 11b: Black population share in 2000 for neighborhoods grouped by HOLC grade

holcblack <- atlas |> 
             mutate(grade = case_when(HOLC_A > 0.5 & !is.na(HOLC_A) ~ 'A',
                                      HOLC_B > 0.5 & !is.na(HOLC_B) ~ 'B',
                                      HOLC_C > 0.5 & !is.na(HOLC_C) ~ 'C',
                                      HOLC_D > 0.5 & !is.na(HOLC_D) ~ 'D')) |> 
            group_by(grade) |> 
            summarize(mean_blackpop = mean(share_black2000, na.rm = TRUE))
                      
holcblack 

```
It is clear that when looking at the racial composition of HOLC graded neighborhoods, we see that neighborhoods graded A have less than half of Black population share as we see in D rated neighborhoods. There is a clear pattern of increasing Black population share as we move across neighborhoods by their HOLC grade. We cannot rule out race as a confounding variable in driving mobility outcomes. 

```{r q11c}

#Q11C: Average of Black and White pooled absolute mobility for neighborhoods grouped by HOLC grade

holcracefixed <- atlas |> 
             mutate(grade = case_when(HOLC_A > 0.5 & !is.na(HOLC_A) ~ 'A',
                                      HOLC_B > 0.5 & !is.na(HOLC_B) ~ 'B',
                                      HOLC_C > 0.5 & !is.na(HOLC_C) ~ 'C',
                                      HOLC_D > 0.5 & !is.na(HOLC_D) ~ 'D')) |> 
            group_by(grade) |> 
            summarize(mean_blackmobil = mean(kfr_black_pooled_p25, na.rm = TRUE),
                      mean_whitemobil = mean(kfr_white_pooled_p25, na.rm = TRUE))
                      
holcracefixed 


```
When we look at absolute mobility rates by HOLC neighborhood grade and race, racial composition cannot be a confounder in this analysis because we are isolating racial variables. When we look solely at Black mobility rates or white mobility rates, we are looking solely at Black child outcomes, so the potential effect that former HOLC neighborhood grade may have on mobility outcomes should be more clear.

Looking at Black and white pooled mobility rates, it's evident that mobility percentile ranks decrease as neighborhood HOLC grades decrease. There is a decrease of roughly 3 percentile ranks for Black children's mobility outcomes between grade A and D neighborhoods. Similarly, there is a decrease of roughly 6 percentile ranks for White children's outcomes between A and D neighborhoods. What's notable is that the average mobility rank for white children living in D neighborhoods remains higher (44 vs. 34) than the average mobility rank for Black children who lived in A neighborhoods. Clearly, HOLC grade and race have separate but similar impacts on mobility outcomes. 

```{r q11d}

#Q11D: 

```

